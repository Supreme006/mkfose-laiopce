<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Mark Otto, Jacob Thornton, and Bootstrap contributors">
    <meta name="generator" content="Hugo 0.84.0">
    <title>Checkout</title>

    <style>
        .bd-placeholder-img {
            font-size: 1.125rem;
            text-anchor: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        @media (min-width: 768px) {
            .bd-placeholder-img-lg {
                font-size: 3.5rem;
            }
        }
    </style>


    <!-- Custom styles for this template -->
    <link href="/css/form-validation.css" rel="stylesheet">
    <%- include('../../partials/css.ejs') %>
        <% let total=0; %>
</head>

<body class="bg-light">
    <%- include("../../partials/loading.ejs") %>
        <%- include("../../partials/navbar.ejs") %>
            <div class="container margin3-top">

                <div class="modal" id="success">
                    <div class="modal-dialog">
                        <div class="modal-content">

                            <!-- Modal body -->
                            <div class="modal-body text-center">
                                test
                            </div>

                        </div>
                    </div>
                </div>

                <button data-bs-toggle="modal" data-bs-target="#success">ae</button>

                <div class="row g-5">
                    <div class="col-md-5 col-lg-4 order-md-last">
                        <h4 class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-primary">Your cart</span>
                            <span class="badge bg-primary rounded-pill">
                                <% if(cart){ %>
                                    <%= cart.length %>
                                        <% } else { %>
                                            0
                                            <% } %>
                            </span>
                        </h4>
                        <ul class="list-group mb-3">
                            <% if(cart){ %>
                                <% cart.forEach(product=> { total = total + product.price; %>
                                    <li class="list-group-item d-flex justify-content-between lh-sm">
                                        <div>
                                            <h6 class="my-0">
                                                <%= product.title %>
                                            </h6>
                                            <small class="text-muted">
                                                <%= product.s_description %>
                                            </small>
                                        </div>
                                        <% if(req.session.value=="usd" ) {%>
                                            <span class="text-muted">$<%= eurtousd(product.price) %></span>
                                            <% } else { %>
                                                <span class="text-muted">
                                                    <%= product.price %>€
                                                </span>
                                                <% } %>
                                    </li>
                                    <% }) %>
                                        <% if(promo) { %>
                                            <% total=percentageOff(total, promo.products); let perc=total -
                                                promo.products %>

                                                <li class="list-group-item d-flex justify-content-between bg-light">
                                                    <div class="text-success">
                                                        <h6 class="my-0">Promo code</h6>
                                                        <small>
                                                            <%= promo.code %>
                                                        </small>
                                                    </div>
                                                    <span class="text-success">-15%</span>

                                                </li>
                                                <% } %>
                                                    <li class="list-group-item d-flex justify-content-between">
                                                        <% if(req.session.value=="usd" ) {%>
                                                            <span>Total (USD)</span>
                                                            <div>
                                                                $<strong id="total"><%= eurtousd(total.toFixed(2)) %></strong>
                                                            </div>
                                                            <% } else { %>
                                                                <span>Total (EUR)</span>
                                                                <div>
                                                                    <strong id="total"><%= total.toFixed(2) %></strong>€
                                                                </div>
                                                                <%}%>
                                                    </li>
                                                    <% } else {%>
                                                        <li class="list-group-item d-flex justify-content-between">
                                                            <% if(req.session.value=="usd" ) {%>
                                                                <span>Total (USD)</span>
                                                                <strong>$0</strong>
                                                                <% } else { %>
                                                                    <span>Total (EUR)</span>
                                                                    <strong>0€</strong>
                                                                    <%}%>
                                                        </li>
                                                        <% } %>
                        </ul>


                        <% if(!cart) {%>
                            <form class="card p-2">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Promo code">
                                    <button type="submit" class="btn btn-secondary disabled">Redeem</button>
                                </div>
                            </form>
                            <% } else { %>
                                <form class="card p-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" placeholder="Promo code" id="promoCode">
                                        <button type="submit" class="btn btn-primary"
                                            onclick="checkPromo()">Redeem</button>
                                    </div>
                                </form>
                                <% } %>
                    </div>
                    <div class="col-md-7 col-lg-8">
                        <h4 class="mb-3">Billing address</h4>
                        <form class="needs-validation" novalidate>
                            <div class="row g-3">
                                <div class="col-sm-6">
                                    <label for="firstName" class="form-label">First name</label>
                                    <input type="text" class="form-control" id="firstName" placeholder="" value=""
                                        required>
                                    <div class="invalid-feedback">
                                        Valid first name is required.
                                    </div>
                                </div>

                                <div class="col-sm-6">
                                    <label for="lastName" class="form-label">Last name</label>
                                    <input type="text" class="form-control" id="lastName" placeholder="" value=""
                                        required>
                                    <div class="invalid-feedback">
                                        Valid last name is required.
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="username" class="form-label">Username</label>
                                    <div class="input-group has-validation">
                                        <span class="input-group-text">@</span>
                                        <input type="text" class="form-control" id="username" placeholder="Username"
                                            required>
                                        <div class="invalid-feedback">
                                            Your username is required.
                                        </div>
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="email" class="form-label">Email <span
                                            class="text-muted">(Optional)</span></label>
                                    <input type="email" class="form-control" id="email" placeholder="you@example.com">
                                    <div class="invalid-feedback">
                                        Please enter a valid email address for shipping updates.
                                    </div>
                                </div>

                                <div class="col-12">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" placeholder="1234 Main St"
                                        required>
                                    <div class="invalid-feedback">
                                        Please enter your shipping address.
                                    </div>
                                </div>

                                <div class="col-md-5">
                                    <label for="country" class="form-label">Country</label>
                                    <select class="form-select" id="country" required>
                                        <option value="">Choose...</option>
                                        <option>Hrvatska</option>
                                        <option>Srbija</option>
                                        <option>Bosna i Hercegovina</option>
                                        <option>Slovanija</option>
                                        <option>Nemacka</option>
                                        <option>Austrija</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Please select a valid country.
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label for="zip" class="form-label">Zip</label>
                                    <input type="text" class="form-control" id="zip" placeholder="" required>
                                    <div class="invalid-feedback">
                                        Zip code required.
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">


                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="save-info">
                                <label class="form-check-label" for="save-info">Save this information for next
                                    time</label>
                            </div>

                            <hr class="my-4">

                            <h4 class="mb-3">Payment</h4>

                            <div class="row gy-3">
                                <div class="col-md-6">
                                    <label for="cc-name" class="form-label">Name on card</label>
                                    <input type="text" class="form-control" id="cc-name" placeholder="" required>
                                    <small class="text-muted">Full name as displayed on card</small>
                                    <div class="invalid-feedback">
                                        Name on card is required
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <label for="cc-number" class="form-label">Credit card number</label>
                                    <input type="text" class="form-control" id="cc-number" placeholder="" required>
                                    <div class="invalid-feedback">
                                        Credit card number is required
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label for="cc-expiration" class="form-label">Expiration Month</label>
                                    <input type="text" class="form-control" id="expirem" placeholder="" required
                                        maxlength="2">
                                    <div class="invalid-feedback">
                                        Expiration month required
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="cc-expiration" class="form-label">Expiration Year</label>
                                    <input type="text" class="form-control" id="expirey" placeholder="" required
                                        maxlength="2">
                                    <div class="invalid-feedback">
                                        Expiration year required
                                    </div>
                                </div>

                                <div class="col-md-3">
                                    <label for="cc-cvv" class="form-label">CVV</label>
                                    <input type="text" class="form-control" id="cc-cvv" placeholder="" required>
                                    <div class="invalid-feedback">
                                        Security code required
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                        </form>

                        <% if(!cart) {%>
                            <button class="w-100 btn btn-primary btn-lg disabled" type="btn">Pay With Credit
                                Card</button>
                            <% } else {%>
                                <button class="w-100 btn btn-primary btn-lg" type="btn" onclick="checkOut()">Pay
                                    With Credit Card</button>
                                <% } %>

                    </div>
                </div>

                <footer class="my-5 pt-5 text-muted text-center text-small">
                    <p class="mb-1">&copy; 2023 ADORES</p>
                    <ul class="list-inline">
                        <li class="list-inline-item"><a href="#">Privacy</a></li>
                        <li class="list-inline-item"><a href="#">Terms</a></li>
                        <li class="list-inline-item"><a href="#">Support</a></li>
                    </ul>
                </footer>
            </div>


            <%- include('../../partials/js.ejs') %>

                <script src="/js/form-validation.js"></script>

                <script>
                    async function checkPromo() {
                        const code = document.getElementById("promoCode").value
                        console.log(code)
                        $.ajax({
                            url: "/checkCode",
                            type: "POST",
                            data: {
                                promo: code
                            },
                            success: (r) => {
                                if (r.code == "invalid") {
                                    alert("invalid")
                                }
                            }
                        });
                    }

                    async function checkOut() {
                        const expirem = document.getElementById("expirem").value;
                        const expirey = document.getElementById("expirey").value;
                        const holder = document.getElementById("cc-name").value;
                        const number = document.getElementById("cc-number").value;
                        const cvv = document.getElementById("cc-cvv").value;
                        const zip = document.getElementById("zip").value;
                        const country = document.getElementById("country").value;
                        const fName = document.getElementById("firstName").value;
                        const lName = document.getElementById("lastName").value
                        const address = document.getElementById("address").value;
                        const email = document.getElementById("email").value;
                        const username = document.getElementById("username").value;
                        const amount = document.getElementById("total").textContent;

                        console.log(amount)

                        $.ajax({
                            url: "/checkout",
                            type: "POST",
                            data: JSON.parse(`{
                                "expirem": "${expirem}",
                                "expirey": "${expirey}",
                                "holder": "${holder}",
                                "number": "${number}",
                                "cvv": "${cvv}",
                                "zip": "${zip}",
                                "country": "${country}",
                                "fName": "${fName}",
                                "lName": "${lName}",
                                "address": "${address}",
                                "email": "${email}",
                                "username": "${username}",
                                "total": "${amount}"
                            }`),
                            success: (r) => {
                                if (r.message) {
                                    alert(r.message)
                                }
                            }
                        });
                    }
                </script>
</body>

</html>